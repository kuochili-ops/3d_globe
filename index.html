<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Crystal Ball | Spherical Motion</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ffff; }
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; height: 100vh; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        #app-ui { 
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 100; 
            background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px); 
            border-top: 1px solid #333; transition: transform 0.5s ease;
            padding-bottom: env(safe-area-inset-bottom);
        }
        #app-ui.collapsed { transform: translateY(calc(100% - 40px)); }

        .handle { width: 100%; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--accent); font-size: 12px; letter-spacing: 2px; }
        .ui-content { padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .ui-row { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        
        input[type="text"] { background: #000; border: 1px solid var(--accent); color: #fff; padding: 10px; border-radius: 8px; flex: 1; font-size: 14px; }
        .btn { padding: 10px 15px; background: #222; border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; }
        .share-btn { background: #007aff !important; border: none !important; font-weight: bold; flex: 1; }
        
        .control-group { flex: 1; display: flex; font-size: 10px; color: var(--accent); flex-direction: column; }
        input[type="range"] { accent-color: var(--accent); }
        #loading-msg { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); color: var(--accent); z-index: 50; display: none; }
    </style>
</head>
<body>

<div id="loading-msg">è¼‰å…¥ä¸­...</div>
<div id="canvas-container"></div>

<div id="app-ui" class="collapsed">
    <div class="handle" id="ui-toggle">â”€â”€ é»æ“Šå±•é–‹è¨­å®š â”€â”€</div>
    <div class="ui-content">
        <div class="ui-row">
            <input type="text" id="textInput" placeholder="è¼¸å…¥æ–‡å­—..." value="SPHERICAL TEXT">
            <input type="color" id="colorPicker" value="#00ffff">
        </div>
        <div class="ui-row">
            <div class="control-group">
                <label>æ—‹è½‰é€Ÿåº¦</label>
                <input type="range" id="speedSlider" min="0" max="3" step="0.1" value="1">
            </div>
            <div class="control-group">
                <label>å‚ç›´ä½ç½® (é«˜åº¦)</label>
                <input type="range" id="heightSlider" min="-1.2" max="1.2" step="0.01" value="0">
            </div>
        </div>
        <div class="ui-row">
            <button class="btn share-btn" id="shareBtn">ğŸ”— åˆ†äº«ç›®å‰è¨­å®š</button>
            <button class="btn" id="resetCam">ğŸ”„ é‡ç½®è¦–è§’</button>
        </div>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

    class SphericalApp {
        constructor() {
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            // ğŸ’¡ æ ¸å¿ƒåƒæ•¸ï¼šå›ºå®šåŠå¾‘ç‚º 1.4ï¼ˆè²¼è¿‘çƒå£ï¼‰ï¼Œé€é vPos æ”¹è®Šå‚ç›´ä»°è§’
            this.params = { 
                speed: 1.0, 
                fixedRadius: 1.42, 
                vPos: 0 
            };
            
            this.charGroups = [];
            this.init();
        }

        async init() {
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(this.renderer.domElement);

            this.camera.position.set(0, 3, 6);
            this.controls = new OrbitControls(this.camera, this.renderer.domElement);
            this.controls.enableDamping = true;
            this.controls.target.set(0, 1.6, 0);

            this._setupScene();
            this._bindUI();

            new RGBELoader().load('https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr', (tex) => {
                tex.mapping = THREE.EquirectangularReflectionMapping;
                this.scene.environment = tex;
            });

            await document.fonts.ready;
            this.updateText();
            this._animate();
        }

        _setupScene() {
            // æ°´æ™¶çƒç»ç’ƒ
            const globeGeo = new THREE.SphereGeometry(1.5, 64, 64);
            const globeMat = new THREE.MeshPhysicalMaterial({ transmission: 1.0, thickness: 0.1, ior: 1.3, transparent: true, opacity: 0.2, depthWrite: false });
            this.globe = new THREE.Mesh(globeGeo, globeMat);
            this.globe.position.y = 1.6;
            this.globe.renderOrder = 100;
            this.scene.add(this.globe);

            // åº•åº§
            const base = new THREE.Mesh(new THREE.CylinderGeometry(1.6, 1.8, 0.4, 32), new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.9 }));
            base.position.y = 0.2;
            this.scene.add(base);
        }

        updateText() {
            const style = '900 400px "Noto Sans TC"';
            const textVal = document.getElementById('textInput').value || " ";
            const color = document.getElementById('colorPicker').value;

            this.charGroups.forEach(g => this.scene.remove(g));
            this.charGroups = [];

            textVal.split('').forEach((char) => {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.font = style; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillStyle = color;
                ctx.fillText(char, 256, 256);
                
                const tex = new THREE.CanvasTexture(canvas);
                const group = new THREE.Group();
                for (let j = 0; j < 8; j++) {
                    const m = new THREE.Mesh(new THREE.PlaneGeometry(0.35, 0.35), new THREE.MeshBasicMaterial({ map: tex, transparent: true, alphaTest: 0.05, side: THREE.DoubleSide }));
                    m.position.z = -j * 0.008;
                    group.add(m);
                }
                group.renderOrder = 50; 
                this.scene.add(group);
                this.charGroups.push(group);
            });
        }

        _bindUI() {
            const get = (id) => document.getElementById(id);
            get('ui-toggle').onclick = () => get('app-ui').classList.toggle('collapsed');
            get('textInput').oninput = () => this.updateText();
            get('colorPicker').oninput = () => this.updateText();
            get('speedSlider').oninput = (e) => this.params.speed = parseFloat(e.target.value);
            
            // ğŸ’¡ é—œéµï¼šé«˜åº¦ç§»å‹•é‚è¼¯
            get('heightSlider').oninput = (e) => this.params.vPos = parseFloat(e.target.value);
            
            get('resetCam').onclick = () => { this.camera.position.set(0, 3, 6); this.controls.target.set(0, 1.6, 0); };
            
            get('shareBtn').onclick = () => {
                const t = encodeURIComponent(get('textInput').value);
                const c = get('colorPicker').value.replace('#', '');
                const h = get('heightSlider').value;
                const shareUrl = `${window.location.origin}${window.location.pathname}?t=${t}&c=${c}&h=${h}`;
                navigator.clipboard.writeText(shareUrl).then(() => alert('åˆ†äº«é€£çµå·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹æ‰“é–‹å³å¯çœ‹åˆ°æ‚¨çš„è¨­å®šã€‚'));
            };
        }

        _animate() {
            requestAnimationFrame(() => this._animate());
            const time = (Date.now() / 1000) * this.params.speed; 
            const total = this.charGroups.length;
            
            // ğŸ’¡ çƒé¢æ•¸å­¸è¨ˆç®—
            const R = this.params.fixedRadius; // å›ºå®šåŠå¾‘ï¼Œä¿è­‰è²¼ç‰†
            const yOffset = this.params.vPos; // å‚ç›´åç§» (é«˜åº¦)
            
            // ç‚ºäº†è®“æ–‡å­—åœ¨ä¸Šä¸‹ç§»å‹•æ™‚ä¾ç„¶è²¼ç‰†ï¼Œæˆ‘å€‘è¨ˆç®—ç•¶å‰é«˜åº¦å°æ‡‰çš„æ°´å¹³åœ“åŠå¾‘
            // å…¬å¼ï¼šr = sqrt(R^2 - y^2)
            const horizontalR = Math.sqrt(Math.max(0.1, R*R - yOffset*yOffset));

            this.charGroups.forEach((g, i) => {
                const angle = (time - (i / total) * Math.PI * 2) % (Math.PI * 2);
                
                // è¨­ç½® 3D ä½ç½®ï¼šé«˜åº¦ y æ˜¯å›ºå®šçš„ï¼Œx å’Œ z æ ¹æ“šé«˜åº¦èª¿æ•´å¾Œçš„åŠå¾‘æ—‹è½‰
                g.position.set(
                    Math.cos(angle) * horizontalR, 
                    1.6 + yOffset, 
                    Math.sin(angle) * horizontalR
                );
                
                // ğŸ’¡ è®“æ–‡å­—å§‹çµ‚é¢å‘çƒå¿ƒ (æˆ–èƒŒå°çƒå¿ƒ)
                g.lookAt(0, 1.6 + yOffset, 0);
                g.rotateY(Math.PI);
            });

            this.controls.update();
            this.renderer.render(this.scene, this.camera);
        }
    }
    new SphericalApp();
</script>
</body>
</html>
