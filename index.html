<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Duck Snow Globe Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ffff; }
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; height: 100vh; touch-action: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        #app-ui { 
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 100; 
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px); 
            border-top: 1px solid #333; padding: 15px 0 env(safe-area-inset-bottom) 0;
            display: flex; flex-direction: column; align-items: center;
        }
        #app-ui.viewer-mode { display: none !important; }

        .ui-content { padding: 0 15px; display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; }
        .ui-row { width: 100%; max-width: 450px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        select, input[type="text"] { background: #111; border: 1.5px solid var(--accent); color: #fff; padding: 12px; border-radius: 10px; flex: 1; font-size: 14px; outline: none; }
        .btn { padding: 12px; background: #222; border: 1px solid #444; border-radius: 10px; color: #fff; font-size: 13px; cursor: pointer; font-weight: bold; }
        .share-btn { background: #007aff !important; border: none !important; flex: 2; }
        input[type="color"] { width: 50px; height: 45px; border: 1.5px solid var(--accent); border-radius: 10px; background: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="canvas-container"></div>

<div id="app-ui">
    <div class="ui-content">
        <div class="ui-row">
            <select id="landmarkSelect">
                <option value="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb">ç¶“å…¸å°é´¨</option>
                <option value="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb">ç§‘å¹»é ­ç›”</option>
            </select>
            <input type="color" id="colorPicker" value="#00ffff">
        </div>
        <div class="ui-row">
            <input type="text" id="textInput" placeholder="è¼¸å…¥æ–‡å­—..." value="LUCKY DUCK">
        </div>
        <div class="ui-row">
            <button class="btn share-btn" id="shareBtn">ğŸ”— åˆ†äº«é©šå–œç¦®ç‰©</button>
            <button class="btn" id="uploadBtn">ğŸ“‚ ä¸Šå‚³ GLB</button>
        </div>
    </div>
</div>

<input type="file" id="real-file-input" accept=".glb,.gltf" style="display:none;">

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    class SnowGlobe {
        constructor() {
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            this.snowCount = 1200;
            this.snowVelocities = [];
            this.charGroups = [];
            this.currentModel = null;
            this.isMoving = false;
            this.moveTimer = 0;
            this.globeY = 1.6;
            this.globeRadius = 1.48;
            this.init();
        }

        async init() {
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(this.renderer.domElement);

            this.camera.position.set(0, 3, 6);
            this.controls = new OrbitControls(this.camera, this.renderer.domElement);
            this.controls.enableDamping = true;
            this.controls.target.set(0, this.globeY, 0);

            this.controls.addEventListener('change', () => {
                this.isMoving = true;
                this.moveTimer = 30; 
            });

            this._setupScene();
            this._setupSnow();
            this._handleURL();
            this._bindUI();

            await document.fonts.ready;
            this.updateText();
            this._loadModel(this.modelUrl || "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb");
            this._animate();
        }

        _setupScene() {
            this.scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(5, 10, 5);
            this.scene.add(sun);

            const globeGeo = new THREE.SphereGeometry(1.5, 64, 64);
            const globeMat = new THREE.MeshPhysicalMaterial({ 
                transmission: 1, thickness: 0.5, transparent: true, opacity: 0.1, ior: 1.5, roughness: 0.05 
            });
            const globe = new THREE.Mesh(globeGeo, globeMat);
            globe.position.y = this.globeY;
            this.scene.add(globe);

            const base = new THREE.Mesh(new THREE.CylinderGeometry(1.6, 1.7, 0.4, 32), new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.8 }));
            base.position.y = 0.2;
            this.scene.add(base);
        }

        _setupSnow() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for (let i = 0; i < this.snowCount; i++) {
                // éš¨æ©Ÿåˆ†ä½ˆåœ¨çƒé«”åº•éƒ¨
                const r = Math.random() * 1.4;
                const theta = Math.random() * Math.PI * 2;
                pos.push(Math.cos(theta)*r, 0.25, Math.sin(theta)*r);
                this.snowVelocities.push(new THREE.Vector3(0,0,0));
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            this.snowSystem = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.02, transparent: true, opacity: 0.8 }));
            this.scene.add(this.snowSystem);
        }

        updateText() {
            const text = document.getElementById('textInput').value || " ";
            const color = document.getElementById('colorPicker').value;
            this.charGroups.forEach(g => this.scene.remove(g));
            this.charGroups = [];

            text.split('').forEach(char => {
                const canvas = document.createElement('canvas');
                canvas.width = 256; canvas.height = 256;
                const ctx = canvas.getContext('2d');
                ctx.font = '900 180px "Noto Sans TC"'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillStyle = color; ctx.fillText(char, 128, 128);
                const tex = new THREE.CanvasTexture(canvas);
                const g = new THREE.Group();
                const m = new THREE.Mesh(new THREE.PlaneGeometry(0.32, 0.32), new THREE.MeshBasicMaterial({map:tex, transparent:true, side: THREE.DoubleSide}));
                g.add(m); this.scene.add(g); this.charGroups.push(g);
            });
        }

        _loadModel(url) {
            new GLTFLoader().load(url, (gltf) => {
                if (this.currentModel) this.scene.remove(this.currentModel);
                this.currentModel = gltf.scene;
                const box = new THREE.Box3().setFromObject(this.currentModel);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                const scale = 1.0 / Math.max(size.x, size.y, size.z);
                this.currentModel.scale.setScalar(scale);
                this.currentModel.position.set(-center.x*scale, this.globeY - center.y*scale, -center.z*scale);
                this.scene.add(this.currentModel);
            });
        }

        _animate() {
            requestAnimationFrame(() => this._animate());
            
            const pos = this.snowSystem.geometry.attributes.position.array;
            for (let i = 0; i < this.snowCount; i++) {
                const ix = i*3, iy = i*3+1, iz = i*3+2;
                
                // ç§»å‹•æ™‚æ“¾å‹•ï¼šçµ¦äºˆéš¨æ©Ÿä¸‰ç¶­æ“¾å‹•å‘é‡
                if (this.isMoving && Math.random() > 0.9) {
                    this.snowVelocities[i].set(
                        (Math.random()-0.5)*0.06, 
                        (Math.random())*0.07, 
                        (Math.random()-0.5)*0.06
                    );
                }

                pos[ix] += this.snowVelocities[i].x;
                pos[iy] += this.snowVelocities[i].y;
                pos[iz] += this.snowVelocities[i].z;

                this.snowVelocities[i].y -= 0.0009; // æº«å’Œé‡åŠ›
                this.snowVelocities[i].multiplyScalar(0.985); // ç©ºæ°£é˜»åŠ›

                // çƒé«”ç¢°æ’åµæ¸¬ (å¼·è¿«é›ªèŠ±ç•™åœ¨çƒå…§)
                const dx = pos[ix], dy = pos[iy]-this.globeY, dz = pos[iz];
                const d = Math.sqrt(dx*dx + dy*dy + dz*dz);
                if (d > this.globeRadius) {
                    const nx = dx/d, ny = dy/d, nz = dz/d;
                    const dot = this.snowVelocities[i].x*nx + this.snowVelocities[i].y*ny + this.snowVelocities[i].z*nz;
                    // åå°„å‘é‡è¨ˆç®—
                    this.snowVelocities[i].x -= 1.6 * dot * nx;
                    this.snowVelocities[i].y -= 1.6 * dot * ny;
                    this.snowVelocities[i].z -= 1.6 * dot * nz;
                    // ä¿®æ­£ä½ç½®é¿å…ç©¿ç‰†
                    pos[ix] = nx * this.globeRadius;
                    pos[iy] = ny * this.globeRadius + this.globeY;
                    pos[iz] = nz * this.globeRadius;
                }

                // åº•åº§é™åˆ¶
                if (pos[iy] < 0.25) {
                    pos[iy] = 0.25;
                    this.snowVelocities[i].set(0,0,0);
                }
            }
            this.snowSystem.geometry.attributes.position.needsUpdate = true;
            if (this.moveTimer > 0) this.moveTimer--; else this.isMoving = false;

            // æ–‡å­—æ—‹è½‰
            const time = Date.now() * 0.0012;
            this.charGroups.forEach((g, i) => {
                const angle = time - (i / this.charGroups.length) * Math.PI * 2;
                g.position.set(Math.cos(angle)*1.43, this.globeY, Math.sin(angle)*1.43);
                g.lookAt(0, this.globeY, 0); g.rotateY(Math.PI);
            });

            if (this.currentModel) this.currentModel.rotation.y += 0.005;
            this.controls.update();
            this.renderer.render(this.scene, this.camera);
        }

        _handleURL() {
            const p = new URLSearchParams(window.location.search);
            if (p.get('view') === '1') document.getElementById('app-ui').classList.add('viewer-mode');
            if (p.has('t')) document.getElementById('textInput').value = decodeURIComponent(p.get('t'));
            if (p.has('c')) document.getElementById('colorPicker').value = '#' + p.get('c');
            this.modelUrl = p.has('m') ? decodeURIComponent(p.get('m')) : null;
        }

        _bindUI() {
            document.getElementById('textInput').oninput = () => this.updateText();
            document.getElementById('colorPicker').oninput = () => this.updateText();
            document.getElementById('landmarkSelect').onchange = (e) => this._loadModel(e.target.value);
            document.getElementById('uploadBtn').onclick = () => document.getElementById('real-file-input').click();
            document.getElementById('real-file-input').onchange = (e) => {
                const f = e.target.files[0];
                if(f) this._loadModel(URL.createObjectURL(f));
            };
            document.getElementById('shareBtn').onclick = () => {
                const t = encodeURIComponent(document.getElementById('textInput').value);
                const c = document.getElementById('colorPicker').value.replace('#','');
                const m = encodeURIComponent(document.getElementById('landmarkSelect').value);
                const url = `${window.location.origin}${window.location.pathname}?t=${t}&c=${c}&m=${m}&view=1`;
                navigator.clipboard.writeText(url).then(() => alert('é©šå–œé€£çµå·²è¤‡è£½ï¼å‚³çµ¦æ”¶è¨Šè€…ï¼Œå°æ–¹å°‡çœ‹ä¸åˆ°æ“ä½œä»‹é¢ã€‚'));
            };
        }
    }
    new SnowGlobe();
</script>
</body>
</html>
