<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Crystal Ball | Shake for Snow</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ffff; }
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; height: 100vh; touch-action: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        /* å¾Œå°ä»‹é¢ */
        #app-ui { 
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 100; 
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); 
            border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom);
        }
        #app-ui.viewer-mode { display: none !important; }

        .ui-content { padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .ui-row { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        select, input[type="text"] { background: #111; border: 1px solid var(--accent); color: #fff; padding: 10px; border-radius: 8px; flex: 1; font-size: 14px; outline: none; }
        .btn { padding: 10px 15px; background: #222; border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; font-weight: bold; }
        .share-btn { background: #007aff !important; border: none !important; flex: 1; }
        
        /* æˆæ¬ŠæŒ‰éˆ• (åƒ…æ”¶è¨Šè€…ä¸”ç‚º iOS æ™‚é¡¯ç¤º) */
        #permission-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center;
        }
        .perm-btn { padding: 20px 40px; background: var(--accent); color: #000; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="permission-overlay">
    <button class="perm-btn" id="requestPerm">é»æ“Šé–‹å•Ÿæ–æ™ƒé©šå–œ</button>
</div>

<div id="canvas-container"></div>

<div id="app-ui">
    <div class="ui-content">
        <div class="ui-row">
            <select id="landmarkSelect">
                <option value="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb">ç¶“å…¸å°é´¨</option>
                <option value="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Lantern/glTF-Binary/Lantern.glb">æ±æ–¹ç‡ˆç± </option>
            </select>
            <input type="color" id="colorPicker" value="#00ffff">
        </div>
        <div class="ui-row">
            <input type="text" id="textInput" placeholder="è¨Šæ¯..." value="SHAKE ME!">
        </div>
        <div class="ui-row">
            <button class="btn share-btn" id="shareBtn">ğŸ”— åˆ†äº«é©šå–œé€£çµ</button>
            <button class="btn" id="uploadBtn">ğŸ“‚ ä¸Šå‚³</button>
        </div>
    </div>
</div>

<input type="file" id="real-file-input" accept=".glb,.gltf" style="display:none;">

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    class SnowApp {
        constructor() {
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            this.params = { speed: 1.0, fixedRadius: 1.42, vPos: 0, modelUrl: '' };
            this.snowCount = 600;
            this.snowVelocities = [];
            this.init();
        }

        async init() {
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(this.renderer.domElement);

            this.camera.position.set(0, 3, 6);
            this.controls = new OrbitControls(this.camera, this.renderer.domElement);
            this.controls.enableDamping = true;
            this.controls.target.set(0, 1.6, 0);

            this._setupScene();
            this._setupSnow();
            this._handleParams();
            this._bindUI();
            this._setupMotion();

            await document.fonts.ready;
            this.updateText();
            this._loadModel(this.params.modelUrl || document.getElementById('landmarkSelect').value);
            this._animate();
        }

        _setupScene() {
            // æ°´æ™¶çƒ
            const globeGeo = new THREE.SphereGeometry(1.5, 64, 64);
            const globeMat = new THREE.MeshPhysicalMaterial({ transmission: 1.0, thickness: 0.1, ior: 1.3, transparent: true, opacity: 0.2, depthWrite: false });
            this.scene.add(new THREE.Mesh(globeGeo, globeMat)).position.y = 1.6;

            // åº•åº§
            const base = new THREE.Mesh(new THREE.CylinderGeometry(1.6, 1.8, 0.4, 32), new THREE.MeshStandardMaterial({ color: 0x111111 }));
            base.position.y = 0.2;
            this.scene.add(base);

            const light = new THREE.PointLight(0xffffff, 10);
            light.position.set(2, 5, 2);
            this.scene.add(light);
            this.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        }

        _setupSnow() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for (let i = 0; i < this.snowCount; i++) {
                // åˆå§‹ä½ç½®åœ¨çƒé«”åº•éƒ¨
                pos.push((Math.random()-0.5)*2, 0.2 + Math.random()*0.5, (Math.random()-0.5)*2);
                this.snowVelocities.push(new THREE.Vector3(0, 0, 0));
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.03, transparent: true, opacity: 0.8 });
            this.snowSystem = new THREE.Points(geo, mat);
            this.scene.add(this.snowSystem);
        }

        _setupMotion() {
            const requestBtn = document.getElementById('requestPerm');
            const overlay = document.getElementById('permission-overlay');

            // åˆ¤æ–·æ˜¯å¦éœ€è¦æˆæ¬Š (iOS 13+)
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                overlay.style.display = 'flex';
                requestBtn.onclick = () => {
                    DeviceMotionEvent.requestPermission().then(res => {
                        if (res === 'granted') {
                            window.addEventListener('devicemotion', (e) => this._onShake(e));
                            overlay.style.display = 'none';
                        }
                    });
                };
            } else {
                // Android æˆ–å…¶ä»–
                window.addEventListener('devicemotion', (e) => this._onShake(e));
            }
        }

        _onShake(event) {
            const acc = event.acceleration;
            if (!acc) return;
            const threshold = 15; // æ–æ™ƒå¼·åº¦é–€æª»
            if (Math.abs(acc.x) > threshold || Math.abs(acc.y) > threshold || Math.abs(acc.z) > threshold) {
                this._shakeSnow();
            }
        }

        _shakeSnow() {
            for (let i = 0; i < this.snowCount; i++) {
                this.snowVelocities[i].set(
                    (Math.random() - 0.5) * 0.05,
                    Math.random() * 0.08,
                    (Math.random() - 0.5) * 0.05
                );
            }
        }

        _animate() {
            requestAnimationFrame(() => this._animate());
            
            // é›ªèŠ±ç‰©ç†é‚è¼¯
            const positions = this.snowSystem.geometry.attributes.position.array;
            for (let i = 0; i < this.snowCount; i++) {
                const ix = i * 3, iy = i * 3 + 1, iz = i * 3 + 2;
                
                // æ‡‰ç”¨é€Ÿåº¦
                positions[ix] += this.snowVelocities[i].x;
                positions[iy] += this.snowVelocities[i].y;
                positions[iz] += this.snowVelocities[i].z;

                // é‡åŠ›èˆ‡ç©ºæ°£é˜»åŠ›
                this.snowVelocities[i].y -= 0.001; // é‡åŠ›
                this.snowVelocities[i].multiplyScalar(0.98); // é˜»åŠ›

                // çƒé«”ç¢°æ’åµæ¸¬ (ä¸­å¿ƒé» 0, 1.6, åŠå¾‘ 1.45)
                const dx = positions[ix], dy = positions[iy] - 1.6, dz = positions[iz];
                const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                if (dist > 1.45) {
                    this.snowVelocities[i].multiplyScalar(-0.5); // æ’åˆ°ç‰†å½ˆå›ä¾†
                }
                
                // åœ°é¢é™åˆ¶
                if (positions[iy] < 0.25) {
                    positions[iy] = 0.25;
                    this.snowVelocities[i].set(0,0,0);
                }
            }
            this.snowSystem.geometry.attributes.position.needsUpdate = true;

            // æ–‡å­—æ—‹è½‰é‚è¼¯
            const time = (Date.now() / 1000) * this.params.speed; 
            const horizontalR = Math.sqrt(Math.max(0.1, this.params.fixedRadius**2 - this.params.vPos**2));
            this.charGroups.forEach((g, i) => {
                const angle = (time - (i / this.charGroups.length) * Math.PI * 2) % (Math.PI * 2);
                g.position.set(Math.cos(angle) * horizontalR, 1.6 + this.params.vPos, Math.sin(angle) * horizontalR);
                g.lookAt(0, 1.6 + this.params.vPos, 0);
                g.rotateY(Math.PI);
            });

            this.controls.update();
            this.renderer.render(this.scene, this.camera);
        }

        // ... (ä¿ç•™ä¹‹å‰çš„ _loadModel, updateText, _bindUI, _handleParams é‚è¼¯)
        _handleParams() {
            const p = new URLSearchParams(window.location.search);
            if (p.get('view')==='1') document.getElementById('app-ui').classList.add('viewer-mode');
            if (p.has('t')) document.getElementById('textInput').value = decodeURIComponent(p.get('t'));
            if (p.has('c')) document.getElementById('colorPicker').value = '#' + p.get('c');
            if (p.has('m')) this.params.modelUrl = decodeURIComponent(p.get('m'));
        }

        _bindUI() {
            const get = (id) => document.getElementById(id);
            get('textInput').oninput = () => this.updateText();
            get('colorPicker').oninput = () => this.updateText();
            get('uploadBtn').onclick = () => get('real-file-input').click();
            get('real-file-input').onchange = (e) => {
                const f = e.target.files[0];
                if(f) this._loadModel(URL.createObjectURL(f));
            };
            get('shareBtn').onclick = () => {
                const t = encodeURIComponent(get('textInput').value);
                const c = get('colorPicker').value.replace('#','');
                const m = encodeURIComponent(get('landmarkSelect').value);
                const url = `${window.location.origin}${window.location.pathname}?t=${t}&c=${c}&m=${m}&view=1`;
                navigator.clipboard.writeText(url).then(() => alert('é©šå–œé€£çµå·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹ï¼Œå«ä»–ã€Œæ–ä¸€æ–ã€æ‰‹æ©Ÿã€‚'));
            };
        }

        updateText() {
            const textVal = document.getElementById('textInput').value || " ";
            const color = document.getElementById('colorPicker').value;
            this.charGroups.forEach(g => this.scene.remove(g));
            this.charGroups = [];
            textVal.split('').forEach(char => {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.font = '900 400px "Noto Sans TC"'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillStyle = color; ctx.fillText(char, 256, 256);
                const tex = new THREE.CanvasTexture(canvas);
                const g = new THREE.Group();
                for(let j=0; j<8; j++){
                    const m = new THREE.Mesh(new THREE.PlaneGeometry(0.35, 0.35), new THREE.MeshBasicMaterial({map:tex, transparent:true, alphaTest:0.1}));
                    m.position.z = -j*0.008; g.add(m);
                }
                this.scene.add(g); this.charGroups.push(g);
            });
        }

        _loadModel(url) {
            new GLTFLoader().load(url, (gltf) => {
                if (this.currentModel) this.scene.remove(this.currentModel);
                this.currentModel = gltf.scene;
                const box = new THREE.Box3().setFromObject(this.currentModel);
                const size = box.getSize(new THREE.Vector3());
                const scale = 1.2 / Math.max(size.x, size.y, size.z);
                this.currentModel.scale.setScalar(scale);
                this.currentModel.position.set(0, 1.6 - (box.getCenter(new THREE.Vector3()).y * scale), 0);
                this.scene.add(this.currentModel);
            });
        }
    }
    new SnowApp();
</script>
</body>
</html>
