<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Globe | Ultimate Showcase</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; height: 100vh; touch-action: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #app-ui { 
            position: absolute !important; bottom: 0; left: 0; width: 100%; z-index: 1000; 
            background: rgba(10, 10, 10, 0.95); padding: 12px 0 env(safe-area-inset-bottom);
            display: flex; flex-direction: column; align-items: center; border-top: 1px solid #333;
        }
        #app-ui.viewer-mode { display: none !important; }
        .ui-content { width: 94%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; }
        .ui-row { display: flex; width: 100%; gap: 6px; align-items: center; }
        input[type="text"], input[type="range"], select { 
            background: #000; border: 1px solid #00ffff; color: #fff; padding: 10px; border-radius: 6px; font-size: 13px; outline: none; flex: 1;
        }
        .label { color: #00ffff; font-size: 11px; min-width: 30px; font-weight: bold; }
        .btn { padding: 12px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; font-size: 12px; color: white; transition: 0.3s; }
        .share-btn { background: #3b82f6; flex: 1.5; }
        .mode-btn { background: #10b981; flex: 1; }
        .upload-btn { background: #444; flex: 0.8; }
        .hint-text { color: #00ffff; font-size: 10px; text-align: center; margin-bottom: 2px; }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div id="app-ui">
    <div class="ui-content">
        <div id="statusHint" class="hint-text">æ­£åœ¨åµæ¸¬ GitHub æ¨¡å‹ç›®éŒ„...</div>
        <div class="ui-row">
            <select id="modelSelect"><option value="">-- é¸æ“‡ç›®éŒ„æ¨¡å‹ --</option></select>
            <button class="btn mode-btn" id="toggleAutoBtn">ğŸ”„ è¼ªæ’­ OFF</button>
        </div>
        <div class="ui-row">
            <input type="text" id="textInput" value="ç’°éŠä¸–ç•Œåƒä¸€å£">
            <input type="color" id="colorPicker" value="#00ffff" style="width:45px; height:38px; background:none; border:none; padding:0;">
        </div>
        <div class="ui-row">
            <span class="label">é«˜åº¦</span>
            <input type="range" id="heightRange" min="50" max="280" value="160">
            <span class="label">é€Ÿåº¦</span>
            <input type="range" id="speedRange" min="0" max="100" value="50">
        </div>
        <div class="ui-row">
            <button class="btn share-btn" id="shareBtn">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
            <button class="btn upload-btn" id="uploadBtn">ğŸ“‚ ä¸Šå‚³æœ¬åœ°</button>
        </div>
    </div>
</div>

<input type="file" id="real-file" accept=".glb,.gltf" style="display:none;">

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // --- é…ç½®æ‚¨çš„ GitHub è³‡è¨Š ---
    const githubUser = 'kuochili-ops'; // æ‚¨çš„ GitHub å¸³è™Ÿ
    const githubRepo = 'kuochili-ops.github.io'; // æ‚¨çš„ Repository åç¨±
    const modelFolderPath = 'model'; // æ¨¡å‹å­˜æ”¾çš„è³‡æ–™å¤¾åç¨±

    let scene, camera, renderer, controls, snowSystem, currentModel;
    let charGroups = [], snowVelocities = [];
    let isMoving = false, moveTimer = 0, textRotation = 0;
    const globeY = 1.6;
    const globeMaxRadius = 1.48;
    const targetModelSize = 2.4;

    let modelPlaylist = [];
    let currentIdx = 0;
    let isAutoMode = false;
    let autoTimer = null;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') === '1') document.getElementById('app-ui').classList.add('viewer-mode');

    async function init() {
        setupScene();
        setupGlobeAndSnow();
        
        await fetchGithubModels(); // 1. è‡ªå‹•æœå°‹ç›®éŒ„

        // åƒæ•¸æ¢å¾©
        if (urlParams.has('t')) document.getElementById('textInput').value = decodeURIComponent(urlParams.get('t'));
        if (urlParams.has('c')) document.getElementById('colorPicker').value = '#' + urlParams.get('c');
        if (urlParams.has('s')) document.getElementById('speedRange').value = urlParams.get('s');
        if (urlParams.has('h')) document.getElementById('heightRange').value = urlParams.get('h');
        
        updateText();

        const startModel = urlParams.get('m');
        if (startModel) {
            loadModel(startModel);
            document.getElementById('modelSelect').value = startModel;
        } else if (modelPlaylist.length > 0) {
            loadModel(modelPlaylist[0].url);
        } else {
            loadModel('https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb');
        }

        if (urlParams.get('auto') === '1') startAutoMode();
        animate();
    }

    async function fetchGithubModels() {
        const apiUrl = `https://api.github.com/repos/${githubUser}/${githubRepo}/contents/${modelFolderPath}`;
        try {
            const response = await fetch(apiUrl);
            const files = await response.json();
            const select = document.getElementById('modelSelect');
            
            modelPlaylist = files
                .filter(file => file.name.endsWith('.glb') || file.name.endsWith('.gltf'))
                .map(file => ({ name: file.name, url: file.download_url }));

            if (modelPlaylist.length > 0) {
                document.getElementById('statusHint').innerText = `å·²ç™¼ç¾ ${modelPlaylist.length} å€‹åœ°æ¨™æ¨¡å‹`;
                modelPlaylist.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.url;
                    opt.innerText = m.name;
                    select.appendChild(opt);
                });
            } else {
                document.getElementById('statusHint').innerText = "model ç›®éŒ„ä¸­æ²’æœ‰ .glb æª”æ¡ˆ";
            }
        } catch (e) {
            document.getElementById('statusHint').innerText = "ç„¡æ³•è®€å– GitHub ç›®éŒ„ï¼Œè«‹ç¢ºèªè·¯å¾‘è¨­å®š";
        }
    }

    function setupScene() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        camera.position.set(0, 3, 6);
        controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, globeY, 0);
        controls.enableDamping = true;
        scene.add(new THREE.AmbientLight(0xffffff, 3.2));
    }

    function setupGlobeAndSnow() {
        const globe = new THREE.Mesh(
            new THREE.SphereGeometry(1.5, 48, 48),
            new THREE.MeshPhysicalMaterial({ transmission: 1, thickness: 0.1, transparent: true, opacity: 0.15, depthWrite: false })
        );
        globe.position.y = globeY;
        scene.add(globe);

        const snowGeo = new THREE.BufferGeometry();
        const posArr = [];
        for (let i = 0; i < 700; i++) {
            posArr.push((Math.random()-0.5)*2.5, 0.3, (Math.random()-0.5)*2.5);
            snowVelocities.push(new THREE.Vector3(0,0,0));
        }
        snowGeo.setAttribute('position', new THREE.Float32BufferAttribute(posArr, 3));
        snowSystem = new THREE.Points(snowGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.02 }));
        scene.add(snowSystem);
    }

    function loadModel(url) {
        if (!url) return;
        new GLTFLoader().load(url, (gltf) => {
            if (currentModel) scene.remove(currentModel);
            currentModel = gltf.scene;
            const box = new THREE.Box3().setFromObject(currentModel);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const scale = targetModelSize / Math.max(size.x, size.y, size.z);
            currentModel.scale.setScalar(scale);
            currentModel.position.set(-center.x * scale, globeY - center.y * scale, -center.z * scale);
            scene.add(currentModel);
        });
    }

    function startAutoMode() {
        isAutoMode = true;
        document.getElementById('toggleAutoBtn').innerText = "â¹ è¼ªæ’­ ON";
        document.getElementById('toggleAutoBtn').style.background = "#ef4444";
        autoTimer = setInterval(() => {
            if (modelPlaylist.length === 0) return;
            currentIdx = (currentIdx + 1) % modelPlaylist.length;
            const targetUrl = modelPlaylist[currentIdx].url;
            loadModel(targetUrl);
            document.getElementById('modelSelect').value = targetUrl;
        }, 60000);
    }

    function stopAutoMode() {
        isAutoMode = false;
        document.getElementById('toggleAutoBtn').innerText = "ğŸ”„ è¼ªæ’­ OFF";
        document.getElementById('toggleAutoBtn').style.background = "#10b981";
        clearInterval(autoTimer);
    }

    function updateText() {
        const textStr = document.getElementById('textInput').value || " ";
        const color = document.getElementById('colorPicker').value;
        charGroups.forEach(g => scene.remove(g));
        charGroups = [];
        Array.from(textStr).forEach((char) => {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color; ctx.font = 'bold 160px "Microsoft JhengHei"';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(char, 128, 128);
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide, alphaTest: 0.4 });
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(0.35, 0.35), mat);
            const g = new THREE.Group(); g.add(mesh);
            scene.add(g); charGroups.push(g);
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const pos = snowSystem.geometry.attributes.position.array;
        for (let i = 0; i < 700; i++) {
            const ix = i*3, iy = i*3+1, iz = i*3+2;
            if (isMoving && Math.random() > 0.85) snowVelocities[i].add(new THREE.Vector3((Math.random()-0.5)*0.02, Math.random()*0.04, (Math.random()-0.5)*0.02));
            pos[ix] += snowVelocities[i].x; pos[iy] += snowVelocities[i].y; pos[iz] += snowVelocities[i].z;
            snowVelocities[i].y -= 0.0012; snowVelocities[i].multiplyScalar(0.96); 
            const dx = pos[ix], dy = pos[iy] - globeY, dz = pos[iz];
            const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
            if (dist > 1.42) {
                const ratio = 1.42 / dist;
                pos[ix] *= ratio; pos[iy] = globeY + (dy * ratio); pos[iz] *= ratio;
                snowVelocities[i].multiplyScalar(-0.15);
            }
            if (pos[iy] < 0.28) { pos[iy] = 0.28; snowVelocities[i].set(0,0,0); }
        }
        snowSystem.geometry.attributes.position.needsUpdate = true;
        if (moveTimer > 0) moveTimer--; else isMoving = false;

        const speed = document.getElementById('speedRange').value / 2500;
        const targetY = document.getElementById('heightRange').value / 100;
        textRotation += speed;
        const relativeY = targetY - globeY; 
        const dynamicRadius = Math.sqrt(Math.max(0, Math.pow(globeMaxRadius, 2) - Math.pow(relativeY, 2))) * 0.98;

        charGroups.forEach((g, i) => {
            const angle = textRotation - (i / charGroups.length) * Math.PI * 2;
            g.position.set(Math.cos(angle) * dynamicRadius, targetY, Math.sin(angle) * dynamicRadius);
            g.lookAt(0, targetY, 0); g.rotateY(Math.PI);
        });
        if (currentModel) currentModel.rotation.y += 0.003;
        controls.update();
        renderer.render(scene, camera);
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('textInput').oninput = updateText;
    document.getElementById('colorPicker').oninput = updateText;
    document.getElementById('modelSelect').onchange = (e) => {
        stopAutoMode();
        loadModel(e.target.value);
    };
    document.getElementById('toggleAutoBtn').onclick = () => {
        if (isAutoMode) stopAutoMode(); else startAutoMode();
    };
    document.getElementById('uploadBtn').onclick = () => document.getElementById('real-file').click();
    document.getElementById('real-file').onchange = (e) => {
        const file = e.target.files[0];
        if (file) { stopAutoMode(); loadModel(URL.createObjectURL(file)); }
    };
    document.getElementById('shareBtn').onclick = () => {
        const t = encodeURIComponent(document.getElementById('textInput').value);
        const c = document.getElementById('colorPicker').value.replace('#','');
        const s = document.getElementById('speedRange').value;
        const h = document.getElementById('heightRange').value;
        const m = encodeURIComponent(document.getElementById('modelSelect').value);
        const a = isAutoMode ? 1 : 0;
        const url = `${window.location.origin}${window.location.pathname}?t=${t}&c=${c}&s=${s}&h=${h}&m=${m}&auto=${a}&view=1`;
        navigator.clipboard.writeText(url).then(() => alert("âœ… åˆ†äº«é€£çµå·²è¤‡è£½ï¼"));
    };
    init();
</script>
</body>
</html>
