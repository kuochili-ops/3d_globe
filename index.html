<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 3D Model & Natural Snow Module</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #1b2735 0%, #090a0f 100%);
        }
        canvas { display: block; }
        
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-family: sans-serif;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div id="ui-overlay">
    <h2>Natural Snow & 3D Module</h2>
    <p>雪花已調整為隨機漂浮模式</p>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- 模組設定 ---
    const config = {
        snowCount: 2000,        // 增加雪花數量
        minSpeed: 0.02,         // 最小下落速度
        maxSpeed: 0.08,         // 最大下落速度
        windIntensity: 0.02,    // 風力隨機強度
        wobbleSpeed: 0.03       // 左右搖擺頻率
    };

    // --- 場景初始化 ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 2, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // 燈光
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(5, 5, 5);
    scene.add(dirLight);

    // --- 自然雪花系統模組 ---
    function createSnow() {
        const geometry = new THREE.BufferGeometry();
        const positions = [];
        const velocities = [];
        const phases = []; // 用於記錄每片雪花的隨機相位（搖擺用）

        for (let i = 0; i < config.snowCount; i++) {
            positions.push(
                (Math.random() - 0.5) * 20, // X
                Math.random() * 20,         // Y
                (Math.random() - 0.5) * 20  // Z
            );
            
            velocities.push(
                (Math.random() - 0.5) * config.windIntensity, // 初始隨機橫向風速
                config.minSpeed + Math.random() * (config.maxSpeed - config.minSpeed), // 垂直速度
                (Math.random() - 0.5) * config.windIntensity  // 深度隨機速度
            );

            phases.push(Math.random() * Math.PI * 2);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        
        // 雪花貼圖 (使用簡單圓點)
        const canvas = document.createElement('canvas');
        canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        grad.addColorStop(0, 'rgba(255,255,255,1)');
        grad.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, 32, 32);
        const texture = new THREE.CanvasTexture(canvas);

        const material = new THREE.PointsMaterial({
            size: 0.05,
            map: texture,
            transparent: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        const points = new THREE.Points(geometry, material);
        scene.add(points);

        return { points, velocities, phases };
    }

    const snowSystem = createSnow();

    // --- 動畫迴圈 ---
    function animate() {
        requestAnimationFrame(animate);
        
        // 更新雪花位置
        const posAttr = snowSystem.points.geometry.attributes.position;
        const time = Date.now() * 0.001;

        for (let i = 0; i < config.snowCount; i++) {
            let x = posAttr.getX(i);
            let y = posAttr.getY(i);
            let z = posAttr.getZ(i);

            // 垂直下落
            y -= snowSystem.velocities[i * 3 + 1];

            // 增加左右搖擺 (Wobble) 與 隨機飄移 (Drift)
            const phase = snowSystem.phases[i];
            x += Math.sin(time + phase) * config.wobbleSpeed;
            z += Math.cos(time + phase) * config.wobbleSpeed;

            // 加上基礎的微弱風向偏移
            x += snowSystem.velocities[i * 3];
            z += snowSystem.velocities[i * 3 + 2];

            // 邊界重置
            if (y < -5) {
                y = 15;
                x = (Math.random() - 0.5) * 20;
                z = (Math.random() - 0.5) * 20;
            }

            posAttr.setXYZ(i, x, y, z);
        }
        posAttr.needsUpdate = true;

        controls.update();
        renderer.render(scene, camera);
    }

    animate();

    // 視窗縮放處理
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --- 載入 GLB 模型 (範例佔位) ---
    // 你可以將路徑替換成從 TRELLIS 或 UltraShape 生成的 URL
    /*
    const loader = new GLTFLoader();
    loader.load('YOUR_MODEL_URL.glb', (gltf) => {
        scene.add(gltf.scene);
    });
    */

</script>
</body>
</html>
