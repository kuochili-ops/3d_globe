<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Globe | Natural Snow V63</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; height: 100vh; touch-action: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: #00ffff; font-family: monospace;
        }
        .loader-bar { width: 220px; height: 4px; background: #222; margin-top: 15px; border-radius: 2px; overflow: hidden; }
        #loader-progress { width: 0%; height: 100%; background: #00ffff; transition: width 0.2s; }

        #app-ui { 
            position: absolute !important; bottom: 0; left: 0; width: 100%; z-index: 1000; 
            background: rgba(10, 10, 10, 0.95); padding: 0;
            display: flex; flex-direction: column; align-items: center; border-top: 1px solid #333;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #app-ui.collapsed { transform: translateY(calc(100% - 40px)); }
        #app-ui.viewer-mode { display: none !important; }

        #toggle-panel-btn {
            width: 100%; height: 40px; background: #1a1a1a; color: #00ffff;
            border: none; border-bottom: 1px solid #333; cursor: pointer; font-size: 12px; font-weight: bold;
        }

        .ui-content { width: 92%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; padding: 12px 0 env(safe-area-inset-bottom); }
        .ui-row { display: flex; width: 100%; gap: 6px; align-items: center; }
        
        input, select, button { 
            background: #000; border: 1px solid #00ffff; color: #fff; padding: 10px; border-radius: 6px; font-size: 13px; outline: none;
        }
        select, input[type="text"] { flex: 1; }
        .label { color: #00ffff; font-size: 11px; min-width: 30px; font-weight: bold; }
        .btn { font-weight: bold; border: none; cursor: pointer; color: white; transition: 0.2s; }
        .share-btn { background: #3b82f6; flex: 1.5; }
        .upload-btn { background: #6366f1; flex: 1; border: 1px solid #818cf8; }
        .mode-btn { background: #10b981; min-width: 90px; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div id="loading-text">è™•ç†ä¸­...</div>
    <div class="loader-bar"><div id="loader-progress"></div></div>
</div>

<div id="canvas-container"></div>

<div id="app-ui">
    <button id="toggle-panel-btn">â–¼ éš±è—æ“ä½œä»‹é¢</button>
    <div class="ui-content">
        <div class="ui-row">
            <select id="modelSelect"><option value="">-- é›²ç«¯æ™¯é» --</option></select>
            <button class="btn mode-btn" id="toggleAutoBtn">ğŸ”„ è¼ªæ’­ OFF</button>
        </div>
        <div class="ui-row">
            <input type="text" id="textInput" value="ç’°éŠä¸–ç•Œåƒä¸€å£">
            <input type="color" id="colorPicker" value="#00ffff" style="width:45px; padding:0; border:none;">
        </div>
        <div class="ui-row">
            <span class="label">é«˜åº¦</span>
            <input type="range" id="heightRange" min="50" max="280" value="160" style="flex:2;">
            <span class="label">é€Ÿåº¦</span>
            <input type="range" id="speedRange" min="0" max="100" value="50" style="flex:2;">
        </div>
        <div class="ui-row">
            <button class="btn upload-btn" id="uploadBtn">ğŸ“‚ ä¸Šå‚³æª”æ¡ˆ</button>
            <button class="btn share-btn" id="shareBtn">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
        </div>
    </div>
</div>

<input type="file" id="fileInput" style="display:none;">

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    let scene, camera, renderer, controls, snowSystem, currentModel, mixer;
    let charGroups = [], snowVelocities = [], snowData = [], clock = new THREE.Clock();
    let textRotation = 0, isInteracting = false, interactTimer = 0;
    const globeY = 1.6, targetModelSize = 2.4;
    let modelPlaylist = [];

    init();

    async function init() {
        setupScene();
        setupGlobeAndSnow();
        await fetchGithubModels();

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('view') === '1') document.getElementById('app-ui').classList.add('viewer-mode');
        if (urlParams.has('t')) document.getElementById('textInput').value = decodeURIComponent(urlParams.get('t'));
        if (urlParams.has('c')) document.getElementById('colorPicker').value = '#' + urlParams.get('c');
        if (urlParams.has('h')) document.getElementById('heightRange').value = urlParams.get('h');
        if (urlParams.has('s')) document.getElementById('speedRange').value = urlParams.get('s');
        
        updateText();
        const mParam = urlParams.get('m');
        if (mParam) loadModel(decodeURIComponent(mParam), false);
        else if(modelPlaylist.length > 0) loadModel(modelPlaylist[0].url, false);

        animate();
    }

    function setupScene() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 3, 6);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, globeY, 0);
        controls.enableDamping = true;
        controls.addEventListener('start', () => { isInteracting = true; interactTimer = 40; });

        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const sun = new THREE.DirectionalLight(0xffffff, 2.0);
        sun.position.set(5, 10, 5);
        scene.add(sun);
    }

    function setupGlobeAndSnow() {
        const globe = new THREE.Mesh(
            new THREE.SphereGeometry(1.5, 32, 32),
            new THREE.MeshPhysicalMaterial({ transmission: 1, thickness: 0.1, transparent: true, opacity: 0.15, depthWrite: false })
        );
        globe.position.y = globeY;
        scene.add(globe);

        const snowCount = 1200; 
        const posArr = [];
        for (let i = 0; i < snowCount; i++) {
            // éš¨æ©Ÿåˆ†ä½ˆåœ¨çƒé«”å…§
            const r = Math.random() * 1.4;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.random() * Math.PI;
            posArr.push(r * Math.sin(phi) * Math.cos(theta), globeY + r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta));
            
            // ç‰©ç†ç‰¹å¾µ (åƒè€ƒç¯„ä¾‹ç¨‹å¼)
            snowData.push({
                speedY: 0.004 + Math.random() * 0.012, 
                phase: Math.random() * Math.PI * 2,
                wobble: 0.002 + Math.random() * 0.006,
                driftSpeed: 0.5 + Math.random() * 1.0
            });
            snowVelocities.push(new THREE.Vector3(0, 0, 0));
        }
        const snowGeo = new THREE.BufferGeometry();
        snowGeo.setAttribute('position', new THREE.Float32BufferAttribute(posArr, 3));
        snowSystem = new THREE.Points(snowGeo, new THREE.PointsMaterial({ 
            color: 0xffffff, size: 0.024, transparent: true, opacity: 0.85, blending: THREE.AdditiveBlending 
        }));
        scene.add(snowSystem);
    }

    function loadModel(url, isImageFile = false) {
        if (!url) return;
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        if (currentModel) { scene.remove(currentModel); if (mixer) mixer.stopAllAction(); }

        if (isImageFile) {
            new THREE.TextureLoader().load(url, (texture) => {
                texture.colorSpace = THREE.SRGBColorSpace;
                const aspect = texture.image.width / texture.image.height;
                const h = 2.2, w = h * aspect, depth = 0.15;
                const sideMat = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.8, roughness: 0.2 });
                const photoMat = new THREE.MeshStandardMaterial({ map: texture, emissive: new THREE.Color(0xffffff), emissiveMap: texture, emissiveIntensity: 0.15 });
                currentModel = new THREE.Mesh(new THREE.BoxGeometry(w, h, depth), [sideMat, sideMat, sideMat, sideMat, photoMat, photoMat]);
                currentModel.position.y = globeY;
                scene.add(currentModel);
                overlay.style.display = 'none';
            }, undefined, () => overlay.style.display = 'none');
        } else {
            new GLTFLoader().load(url, (gltf) => {
                currentModel = gltf.scene;
                currentModel.traverse(node => { if (node.isMesh && node.material && node.material.color && node.material.color.r > 0.95 && !node.material.map) node.material.color.setHex(0xbbbbbb); });
                const box = new THREE.Box3().setFromObject(currentModel);
                const size = box.getSize(new THREE.Vector3()), center = box.getCenter(new THREE.Vector3()), scale = targetModelSize / Math.max(size.x, size.y, size.z);
                currentModel.scale.setScalar(scale);
                currentModel.position.set(-center.x * scale, globeY - center.y * scale, -center.z * scale);
                if (gltf.animations.length > 0) { mixer = new THREE.AnimationMixer(currentModel); gltf.animations.forEach(clip => mixer.clipAction(clip).play()); } else { mixer = null; }
                scene.add(currentModel);
                overlay.style.display = 'none';
            }, undefined, () => overlay.style.display = 'none');
        }
    }

    async function fetchGithubModels() {
        try {
            const res = await fetch(`https://api.github.com/repos/kuochili-ops/3d_globe/contents/model`);
            const files = await res.json();
            const select = document.getElementById('modelSelect');
            modelPlaylist = files.filter(f => f.name.toLowerCase().endsWith('.glb')).map(f => ({ name: f.name.replace('.glb',''), url: `https://raw.githubusercontent.com/kuochili-ops/3d_globe/main/model/${f.name}` }));
            modelPlaylist.forEach(m => { const opt = document.createElement('option'); opt.value = m.url; opt.innerText = "â˜ï¸ " + m.name; select.appendChild(opt); });
        } catch (e) { }
    }

    document.getElementById('toggle-panel-btn').onclick = function() {
        const ui = document.getElementById('app-ui'); ui.classList.toggle('collapsed');
        this.innerText = ui.classList.contains('collapsed') ? "â–² é¡¯ç¤ºæ“ä½œä»‹é¢" : "â–¼ éš±è—æ“ä½œä»‹é¢";
    };

    document.getElementById('uploadBtn').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        loadModel(URL.createObjectURL(file), file.type.startsWith('image/'));
    };

    function updateText() {
        const textStr = document.getElementById('textInput').value || " ";
        const color = document.getElementById('colorPicker').value;
        charGroups.forEach(g => scene.remove(g)); charGroups = [];
        Array.from(textStr).forEach((char) => {
            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = color; ctx.font = 'bold 160px "Microsoft JhengHei"'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(char, 128, 128);
            const tex = new THREE.CanvasTexture(canvas); const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide, alphaTest: 0.3 });
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(0.35, 0.35), mat); const g = new THREE.Group(); g.add(mesh); scene.add(g); charGroups.push(g);
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta(), time = clock.getElapsedTime();
        if (mixer) mixer.update(delta);

        const pos = snowSystem.geometry.attributes.position.array;
        for (let i = 0; i < snowData.length; i++) {
            const ix = i*3, iy = i*3+1, iz = i*3+2;
            const data = snowData[i];

            // 1. è‡ªç„¶ä¸‹è½èˆ‡æ“ºå‹•
            if (isInteracting) {
                // è¢«æ’¥å‹•æ™‚çš„å™´ç™¼åŠ›
                snowVelocities[i].y += Math.random()*0.015;
                pos[ix] += (Math.random()-0.5)*0.03;
                pos[iz] += (Math.random()-0.5)*0.03;
            } else {
                // å¹³æ™‚çš„è‡ªç„¶ä¸‹å¢œ
                pos[iy] -= data.speedY;
                // é—œéµï¼šä½¿ç”¨ç›¸ä½ (Phase) ç”¢ç”Ÿéš¨æ©Ÿå·¦å³é£„å‹•
                pos[ix] += Math.sin(time * data.driftSpeed + data.phase) * data.wobble;
                pos[iz] += Math.cos(time * data.driftSpeed + data.phase) * data.wobble;
            }

            // 2. æ°´æ™¶çƒç¢°æ’èˆ‡åº•éƒ¨ç©é›ª
            const dx = pos[ix], dy = pos[iy] - globeY, dz = pos[iz];
            const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);

            // å¦‚æœè¶…å‡ºçƒé«”æˆ–æ‰åˆ°æ¥µé™åº•éƒ¨
            if (dist > 1.45 || pos[iy] < 0.28) {
                if (pos[iy] < 0.35 && !isInteracting) {
                    // åº•éƒ¨ç©é›ªæ•ˆæœï¼šåœ¨é‚£è£¡åœç•™ä¸€æ®µæ™‚é–“
                    if (Math.random() > 0.985) { // éš¨æ©Ÿé‡ç½®å›é ‚éƒ¨ï¼Œä¿æŒå¾ªç’°
                        const r = Math.random() * 1.2;
                        const theta = Math.random() * Math.PI * 2;
                        pos[ix] = r * Math.cos(theta);
                        pos[iy] = globeY + 1.3 + Math.random() * 0.2;
                        pos[iz] = r * Math.sin(theta);
                    } else {
                        // ä¿æŒåœ¨åº•éƒ¨å¾®å¾®æ™ƒå‹•
                        pos[iy] = 0.26 + Math.random() * 0.1;
                    }
                } else if (dist > 1.45) {
                    // çƒå£ç¢°æ’åå½ˆ
                    const ratio = 1.45 / dist;
                    pos[ix] *= ratio; pos[iy] = globeY + (dy * ratio); pos[iz] *= ratio;
                }
            }
        }
        snowSystem.geometry.attributes.position.needsUpdate = true;
        if (interactTimer > 0) interactTimer--; else isInteracting = false;

        const speed = document.getElementById('speedRange').value / 2500, targetY = document.getElementById('heightRange').value / 100;
        textRotation += speed;
        const relY = targetY - globeY, dynR = Math.sqrt(Math.max(0, 1.48*1.48 - relY*relY)) * 0.97;
        charGroups.forEach((g, i) => {
            const angle = textRotation - (i / charGroups.length) * Math.PI * 2;
            g.position.set(Math.cos(angle) * dynR, targetY, Math.sin(angle) * dynR); g.lookAt(0, targetY, 0); g.rotateY(Math.PI);
        });

        if (currentModel) currentModel.rotation.y += 0.005;
        controls.update(); renderer.render(scene, camera);
    }

    document.getElementById('textInput').oninput = updateText;
    document.getElementById('colorPicker').oninput = updateText;
    document.getElementById('modelSelect').onchange = (e) => loadModel(e.target.value, false);
    document.getElementById('shareBtn').onclick = () => {
        const url = `${window.location.origin}${window.location.pathname}?t=${encodeURIComponent(document.getElementById('textInput').value)}&c=${document.getElementById('colorPicker').value.replace('#','')}&m=${encodeURIComponent(document.getElementById('modelSelect').value)}&h=${document.getElementById('heightRange').value}&s=${document.getElementById('speedRange').value}&view=1`;
        navigator.clipboard.writeText(url).then(() => alert("âœ… è‡ªç„¶é£„é›ªç‰ˆé€£çµå·²è¤‡è£½ï¼"));
    };
</script>
</body>
</html>
