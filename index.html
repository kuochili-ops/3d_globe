<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Crystal Ball Lettering</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@900&family=Long+Cang&family=ZCOOL+QingKe+HuangYou&family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; height: 100vh; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        /* UI é¢æ¿ */
        #app-ui { 
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 100; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); 
            border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); 
        }
        .ui-content { padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .ui-row { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .control-group { flex: 1; display: flex; flex-direction: column; }
        label { color: #00ffff; font-size: 10px; font-weight: bold; margin-bottom: 4px; }
        
        input[type="range"] { width: 100%; accent-color: #00ffff; }
        input[type="text"] { background: #111; border: 1px solid #0ff; color: #fff; padding: 10px; border-radius: 8px; flex: 1; font-size: 14px; }
        .btn { padding: 10px 15px; background: #222; border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; }
        
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00ffff; z-index: 50; display: none; }
    </style>
</head>
<body>

<div id="loading">è¼‰å…¥æ¨¡å‹ä¸­...</div>
<div id="canvas-container"></div>

<div id="app-ui">
    <div class="ui-content">
        <div class="ui-row">
            <input type="text" id="textInput" value="CRYSTAL BALL 3D">
            <input type="color" id="colorPicker" value="#00ffff" style="width:45px; height:45px; border:none; background:none;">
            <button class="btn" id="fontToggle">å­—å‹åˆ‡æ›</button>
        </div>
        
        <div class="ui-row">
            <div class="control-group">
                <label>æ—‹è½‰é€Ÿåº¦ SPEED</label>
                <input type="range" id="speedSlider" min="0.1" max="3.0" step="0.1" value="0.8">
            </div>
            <div class="control-group">
                <label>ç’°ç¹åŠå¾‘ RADIUS</label>
                <input type="range" id="radiusSlider" min="1.0" max="1.48" step="0.01" value="1.42">
            </div>
        </div>

        <div class="ui-row">
            <button class="btn" id="loadModelBtn" style="flex:1; background:#007aff;">ğŸ“‚ ä¸Šå‚³ GLB æ¨¡å‹</button>
            <button class="btn" id="toggleGlobe" style="flex:0.5;">éš±è—ç»ç’ƒ</button>
        </div>
    </div>
</div>

<input type="file" id="file-input" accept=".glb,.gltf" style="display:none;">

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

    class CrystalLetteringApp {
        constructor() {
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            this.params = {
                speed: 0.8,
                radius: 1.42,
                spacing: 0.1, // åœ“å½¢æ¨¡å¼ä¸‹ä¸»è¦ç”±æ–‡å­—é•·åº¦æ±ºå®šé–“è·
                fontIdx: 0,
                fontStyles: [
                    '900 400px "Noto Serif TC"', 
                    '400 400px "Long Cang"', 
                    '400 400px "ZCOOL QingKe HuangYou"', 
                    '900 400px "Noto Sans TC"'
                ]
            };

            this.loader = new GLTFLoader();
            this.model = null;
            this.globe = null;
            this.charGroups = [];
            
            this.init();
        }

        async init() {
            // æ¸²æŸ“å™¨è¨­å®š
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.setPixelRatio(window.devicePixelRatio);
            this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.getElementById('canvas-container').appendChild(this.renderer.domElement);

            // ç›¸æ©Ÿèˆ‡è»Œé“æ§åˆ¶
            this.camera.position.set(0, 3, 6);
            this.orbit = new OrbitControls(this.camera, this.renderer.domElement);
            this.orbit.enableDamping = true;

            // ç’°å¢ƒèˆ‡å…‰ç·š
            new RGBELoader().load('https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr', (tex) => {
                tex.mapping = THREE.EquirectangularReflectionMapping;
                this.scene.environment = tex;
            });

            this._createGlobe();
            this._bindUI();
            
            // åˆå§‹æ–‡å­—ç”Ÿæˆ
            await this.updateText();
            this._renderLoop();
        }

        _createGlobe() {
            // æ°´æ™¶çƒç»ç’ƒ
            const globeGeo = new THREE.SphereGeometry(1.5, 64, 64);
            const globeMat = new THREE.MeshPhysicalMaterial({
                transmission: 1.0, thickness: 0.05, ior: 1.3,
                roughness: 0, transparent: true, opacity: 0.15, color: 0xffffff
            });
            this.globe = new THREE.Mesh(globeGeo, globeMat);
            this.globe.position.y = 1.6;
            this.scene.add(this.globe);

            // åº•åº§
            const base = new THREE.Mesh(
                new THREE.CylinderGeometry(1.6, 1.8, 0.4, 32),
                new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.9 })
            );
            base.position.y = 0.2;
            this.scene.add(base);
        }

        _bindUI() {
            const get = (id) => document.getElementById(id);
            
            get('textInput').oninput = () => this.updateText();
            get('colorPicker').oninput = () => this.updateText();
            get('speedSlider').oninput = (e) => this.params.speed = parseFloat(e.target.value);
            get('radiusSlider').oninput = (e) => this.params.radius = parseFloat(e.target.value);
            
            get('fontToggle').onclick = () => {
                this.params.fontIdx = (this.params.fontIdx + 1) % 4;
                this.updateText();
            };

            get('toggleGlobe').onclick = (e) => {
                this.globe.visible = !this.globe.visible;
                e.target.innerText = this.globe.visible ? "éš±è—ç»ç’ƒ" : "é¡¯ç¤ºç»ç’ƒ";
            };

            get('loadModelBtn').onclick = () => get('file-input').click();
            get('file-input').onchange = (e) => {
                const file = e.target.files[0];
                if (file) this.loadUserModel(URL.createObjectURL(file));
            };

            window.addEventListener('resize', () => {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        loadUserModel(url) {
            if (this.model) this.scene.remove(this.model);
            document.getElementById('loading').style.display = 'block';
            this.loader.load(url, (gltf) => {
                this.model = gltf.scene;
                const box = new THREE.Box3().setFromObject(this.model);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                const scale = 1.2 / Math.max(size.x, size.y, size.z);
                this.model.scale.setScalar(scale);
                this.model.position.set(-center.x*scale, -center.y*scale + 1.6, -center.z*scale);
                this.scene.add(this.model);
                document.getElementById('loading').style.display = 'none';
            });
        }

        async updateText() {
            const style = this.params.fontStyles[this.params.fontIdx];
            if (!document.fonts.check(style)) await document.fonts.load(style);
            
            // æ¸…é™¤èˆŠæ–‡å­—
            this.charGroups.forEach(g => this.scene.remove(g));
            this.charGroups = [];

            const text = (document.getElementById('textInput').value || " ").split('');
            const color = document.getElementById('colorPicker').value;

            text.forEach((char) => {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.font = style; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillStyle = color;
                ctx.fillText(char, 256, 256);

                const tex = new THREE.CanvasTexture(canvas);
                const group = new THREE.Group();

                // FlipBoard åšåº¦æ•ˆæœ (10å±¤)
                for (let j = 0; j < 10; j++) {
                    const m = new THREE.Mesh(
                        new THREE.PlaneGeometry(0.4, 0.4), // ç¸®å°æ–‡å­—ä»¥ç¬¦åˆæ°´æ™¶çƒ
                        new THREE.MeshBasicMaterial({ map: tex, transparent: true, alphaTest: 0.1, side: THREE.DoubleSide })
                    );
                    m.position.z = -j * 0.005;
                    group.add(m);
                }
                this.scene.add(group);
                this.charGroups.push(group);
            });
        }

        _animateText() {
            const time = (Date.now() / 1000) * this.params.speed;
            const radius = this.params.radius;
            const totalChars = this.charGroups.length;

            this.charGroups.forEach((g, i) => {
                // å°‡æ–‡å­—å¹³å‡åˆ†ä½ˆåœ¨åœ“å‘¨ä¸Š
                const angle = (time + (i / totalChars) * Math.PI * 2) % (Math.PI * 2);
                
                // è¨ˆç®—åœ“å‘¨åº§æ¨™ (æ°´å¹³ç’°ç¹æ°´æ™¶çƒä¸­å¿ƒ)
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;
                const y = 1.6; // æ°´æ™¶çƒä¸­å¿ƒé«˜åº¦

                g.position.set(x, y, z);
                
                // è®“æ–‡å­—å§‹çµ‚é¢å‘çƒå¿ƒæˆ–èƒŒå‘çƒå¿ƒ (èª¿æ•´æ–¹å‘ä½¿å…¶å¯è®€)
                g.lookAt(0, y, 0); 
                g.rotateY(Math.PI); // ç¿»è½‰æ–‡å­—é¢å‘å¤–é¢
            });
        }

        _renderLoop() {
            requestAnimationFrame(() => this._renderLoop());
            this.orbit.update();
            this._animateText();
            if (this.model) this.model.rotation.y += 0.005; // æ¨¡å‹è‡ªè½‰
            this.renderer.render(this.scene, this.camera);
        }
    }

    window.onload = () => new CrystalLetteringApp();
</script>
</body>
</html>
